name: CI/CD Pipeline with Keploy, Unit, Integration & API Tests

on:
    push:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            # Step 1: Checkout the code
            - name: Checkout code
              uses: actions/checkout@v4

            # Step 2: Set up Go
            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                  go-version: 1.24

            # Step 3: Install dependencies
            - name: Install dependencies
              run: go mod tidy

            # Step 4: Create Docker network
            - name: Create MySQL Docker network
              run: docker network create mysql-network

            # Step 5: Start MySQL container for test DB (integration/API)
            - name: Start Test DB (Port 5011)
              run: |
                  docker run -d \
                    --name mysql-anime-watch-list-test \
                    --network mysql-network \
                    -e MYSQL_ROOT_PASSWORD=testqwerty \
                    -e MYSQL_DATABASE=test-anime-watch-list \
                    -p 5011:3306 \
                    mysql:latest

            # Step 6: Start MySQL container for unit test read DB (Port 5010)
            - name: Start Read DB for Unit Tests (Port 5010)
              run: |
                  docker run -d \
                    --name mysql-anime-watch-list-read \
                    --network mysql-network \
                    -e MYSQL_ROOT_PASSWORD=qwerty \
                    -e MYSQL_DATABASE=anime-watch-list \
                    -p 5010:3306 \
                    mysql:latest

            # Step 7: Wait for both MySQL DBs to be ready
            - name: Wait for MySQL readiness
              run: |
                  for i in {1..30}; do
                    if docker exec mysql-anime-watch-list-test mysqladmin ping -ptestqwerty --silent && \
                       docker exec mysql-anime-watch-list-read mysqladmin ping -pqwerty --silent; then
                      echo "Both MySQL DBs are ready!"
                      break
                    fi
                    echo "Waiting for MySQL DBs..."
                    sleep 2
                  done

            # Step 8: Run Unit Tests
            - name: Run Unit Tests
              env:
                  MYSQL_USER: root
                  MYSQL_PASSWORD: qwerty
                  MYSQL_HOST: 127.0.0.1
                  MYSQL_PORT: 5010
                  MYSQL_DATABASE: anime-watch-list
              run: go test -v ./tests/unit/...

            # Step 9: Run Integration + API Tests
            - name: Run Integration & API Tests
              run: go test -v ./tests/integration/... ./tests/api/...

            # Step 10: Install Keploy
            - name: Install Keploy
              run: curl --silent -L https://keploy.io/ent/install.sh | bash

            # Step 11: Run Keploy Test Suite
            - name: Run Keploy Test Suite
              run: |
                  keploy test-suite \
                    --app=681a05812921eade9b097454@all \
                    --base-path http://localhost:8080/books \
                    --cloud
